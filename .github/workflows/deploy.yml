name: 🚀 Deploy Backend to EC2

on:
  push:
    branches: ["main"]
  workflow_dispatch: # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout repository
        uses: actions/checkout@v4

      - name: 🧩 Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin

      - name: 🔧 Deploy to EC2 (via SSH)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script_stop: true
          pty: true
          timeout: 10m
          command_timeout: 5m
          script: |
            echo "===== 🚀 Deploy Start $(date) ====="
            source /etc/profile
            source ~/.bashrc

            cd /home/ubuntu/app/2025JavaProject/backend

            echo "> 🧭 Fetch latest code from GitHub"
            git fetch --all
            git reset --hard origin/admin
            git pull origin admin

            echo "> 🧹 Clean up old containers"
            docker stop library-app || true
            docker rm library-app || true

            echo "> 🏗️ Build Spring Boot JAR"
            chmod +x ./gradlew
            ./gradlew clean bootJar -x test --console=plain --no-daemon 2>&1 | tee gradle.log

            echo "> 🐋 Build Docker image"
            docker build -t library-backend . 2>&1 | tee docker.log

            echo "> 🚀 Run new container"
            docker run -d -p 8080:8080 --name library-app library-backend

            echo "===== ✅ Deploy Complete $(date) ====="
